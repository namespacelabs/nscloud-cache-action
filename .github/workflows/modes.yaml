name: Modes

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '*'
  merge_group:
    types: [checks_requested]
  schedule:
    - cron: '10 */6 * * *'

jobs:
  apt:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: apt
      - run: |
          sudo apt-get update
          sudo apt-get install -y lcov
          lcov -h

  brew:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [namespace-profile-macos, namespace-profile-e2e-small]
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: brew
      - run: |
          brew --version
          brew install hello
          which hello
      - if: runner.os == 'macOS'
        # Not available on Linux.
        run: brew tap vectordotdev/brew && brew install vector

  bun:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: bun
      - run: |
          bun install

  cocoapods:
    runs-on: namespace-profile-macos
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: cocoapods
      - name: Create minimal Podfile
        run: |
          cat > Podfile << 'EOF'
          install! 'cocoapods', :integrate_targets => false
          platform :ios, '14.0'
          target 'TestApp' do
            pod 'Alamofire', '~> 5.9'
          end
          EOF
      - run: pod install

  composer:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: composer
      - run: composer require monolog/monolog

  deno:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          cache: false
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: deno
      - run: |
          deno install

  go:
    runs-on: namespace-profile-e2e-medium
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: false
      - name: Check existing directories
        run: |
          ls -al /home/runner/go
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: go
      - name: Run go build
        run: |
          go install namespacelabs.dev/foundation/cmd/ns@aabde5de6327f5e37673fd6d04474890429494ef

  golangci-lint:
    runs-on: namespace-profile-e2e-medium
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/go-cache
          path: demo
      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: '1.25'
          cache: false
      - name: Setup golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6
          install-only: true
          skip-cache: true
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: |
            go
            golangci-lint
      - name: Run golangci-lint
        run: cd ./demo && golangci-lint run

  gradle:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/gradle-cache
          path: demo
      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: gradle
      - name: Build with Gradle
        run: ./gradlew build
        working-directory: ./demo

  maven:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/selenium-cache
          path: demo
      - name: Set up JDK 11
        uses: actions/setup-java@v5
        with:
          java-version: '11'
          distribution: 'temurin'
      - uses: browser-actions/setup-chrome@v2
        with:
          chrome-version: latest
      - run: chrome --version
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: maven
      - name: Build with Maven
        run: mvn -B clean test
        working-directory: ./demo

  mise:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: mise
      - name: Install mise
        uses: jdx/mise-action@v3
        with:
          cache: false
          mise_toml: |
            [tools]
            node = "latest"
      - run: node --version

  nix:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: nix
      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            system-features = kvm nixos-test
      - run: echo "Hello Nix" | nix run "https://flakehub.com/f/snowfallorg/cowsay/1.3.0"

  playwright:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [namespace-profile-macos, namespace-profile-e2e-small]
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: playwright
      - run: npx playwright install --with-deps

  playwright-custom-dir:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [namespace-profile-macos, namespace-profile-e2e-small]
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    env:
      PLAYWRIGHT_BROWSERS_PATH: ~/playwright-cache
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: playwright
      - run: npx playwright install --with-deps

  pnpm:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [namespace-profile-macos, namespace-profile-e2e-small]
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
        with:
          path: nscloud-cache-action
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/cache-pnpm-workspace
          path: demo
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: '10.3.0'
      - name: Setup cache
        uses: ./nscloud-cache-action
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: pnpm
          path: |
            ~/.cache
      - run: pnpm install
        working-directory: ./demo/fullstack

  pnpm-ignore-warnings:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        pnpm-version: ['8.15.5', '9.7.0', '9.15.0']
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
        with:
          path: nscloud-cache-action
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ matrix.pnpm-version }}
      - name: Produce problematic .npmrc
        run: cp ./nscloud-cache-action/.github/workflows/testdata/.npmrc .
      - name: Setup cache
        uses: ./nscloud-cache-action
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: pnpm

  poetry:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/poetry
          path: demo
      - name: Install poetry
        run: pipx install poetry
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: poetry
      - run: poetry install
        working-directory: ./demo

  python:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/python-cache
          path: demo
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: python
      - run: pip install -r ./requirements.txt
        working-directory: ./demo

  rust:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/rust-cache
          path: demo
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: rust
      - run: cargo build --locked --release --no-default-features --all
        working-directory: ./demo
      - run: cargo test --locked --release --all
        working-directory: ./demo

  ruby:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: ruby
      - run: |
          bundle config set --local path 'vendor/bundle'
          bundle init
          bundle add rake

  rust-pre-existing-file:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        # space-version: ['', 'dev', 'latest']
        space-version: ['dev'] # TODO: fix release
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/rust-cache
          path: demo
      - name: Create .global-cache file that should be removed before creating mount
        run: touch ~/.cargo/.global-cache
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: rust
      - run: cargo build --locked --release --no-default-features --all
        working-directory: ./demo
      - run: cargo test --locked --release --all
        working-directory: ./demo

  swiftpm:
    runs-on: namespace-profile-macos
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: swiftpm
      - name: Create and build Swift package
        run: |
          swift package init --type executable
          swift build

  uv:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: false
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: uv
      - run: |
          uv venv
          uv pip install requests

  yarn:
    runs-on: namespace-profile-e2e-small
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - uses: actions/checkout@v6
      - uses: actions/checkout@v6
        with:
          repository: namespace-integration-demos/cache-yarn-workspaces
          path: demo
      - name: Setup cache
        uses: ./
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: yarn
      - run: yarn
        working-directory: ./demo
      - run: yarn workspace @project/web-app build
        working-directory: ./demo

  xcode:
    runs-on:
      - nscloud-macos-sequoia-arm64-12x28-with-cache
      - nscloud-cache-size-50gb
      - nscloud-cache-tag-xcode-swift-ruby
    strategy:
      matrix:
        space-enabled: [false, true]
        space-version: ['', 'dev', 'latest']
    steps:
      - name: Checkout ios-demo
        uses: actions/checkout@v6
        with:
          repository: nscloud-demo/ios-demo
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2.7'
          bundler-cache: false
      - uses: actions/checkout@v6
        with:
          path: cache-action
      - name: Setup cache
        uses: ./cache-action/
        with:
          space-enabled: ${{ matrix.space-enabled }}
          space-version: ${{ matrix.space-version }}
          mode: |
            xcode
            swiftpm
            ruby
      - name: Select Xcode 16.4
        run: |
          if [ -d "/Applications/Xcode_16.4.app" ]; then
            sudo xcode-select -s /Applications/Xcode_16.4.app
          fi
      - name: Wait for iPhone 15 simulator
        run: |
          set -o pipefail
          for i in {1..24}; do
            echo "Looking for iPhone 15 simulator (attempt $i)..."
            if xcrun simctl list -j | jq '.devices["com.apple.CoreSimulator.SimRuntime.iOS-17-5"][] | select(.name == "iPhone 15" and .isAvailable)' -e; then
              echo "Found iPhone 15."
              break
            fi
            sleep 5
          done
      - name: Boot simulator
        run: |
          UDID=$(xcrun simctl list -j | jq -r '.devices["com.apple.CoreSimulator.SimRuntime.iOS-17-5"][] | select(.name == "iPhone 15" and .isAvailable) | .udid')
          echo "Booting simulator $UDID..."
          xcrun simctl boot "$UDID" || true
          xcrun simctl bootstatus "$UDID" -b
      - name: xcodebuild
        run: xcodebuild test -scheme ios-demo -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' -retry-tests-on-failure -test-iterations 3
      - name: fastlane
        run: fastlane screenshots
